name: Build Windows Installer

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:  # Cho phép chạy thủ công từ GitHub UI

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install FFmpeg
      run: |
        choco install ffmpeg -y
        ffmpeg -version
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install streamlit pandas requests python-dotenv
        pip install moviepy pydub ffmpeg-python yt-dlp
        pip install torch torchaudio --index-url https://download.pytorch.org/whl/cpu
        pip install numba llvmlite
        pip install openai-whisper
        pip install pywebview
    
    - name: Build with PyInstaller
      run: |
        pyinstaller visub.spec --noconfirm
        
    - name: Download Inno Setup
      run: |
        choco install innosetup -y
        
    - name: Build Installer
      run: |
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer\setup.iss
        
    - name: Upload Installer Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Visub_Setup
        path: installer/output/Visub_Setup.exe
        retention-days: 30
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: installer/output/Visub_Setup.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
