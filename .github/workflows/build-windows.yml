name: Build Windows Installer

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install FFmpeg
      run: |
        choco install ffmpeg -y
        ffmpeg -version
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip wheel setuptools
        
        # Core
        pip install pyinstaller
        pip install streamlit pandas requests python-dotenv
        
        # Media
        pip install moviepy pydub ffmpeg-python yt-dlp
        
        # AI/ML (CPU only for smaller size)
        pip install torch torchaudio --index-url https://download.pytorch.org/whl/cpu
        pip install numba llvmlite
        pip install openai-whisper
        
        # Streamlit dependencies that need explicit install
        pip install altair pydeck validators watchdog tornado
        pip install pillow packaging importlib-metadata
        
        # MoviePy dependencies (need metadata)
        pip install imageio imageio-ffmpeg decorator tqdm proglog
    
    - name: Build with PyInstaller
      run: |
        pyinstaller visub.spec --noconfirm
        
    - name: Verify build output
      run: |
        if (Test-Path "dist\VietDub\VietDub.exe") {
          Write-Host "Build successful! VietDub.exe exists."
          Get-ChildItem "dist\VietDub" | Measure-Object | Select-Object -ExpandProperty Count
        } else {
          Write-Error "Build failed! VietDub.exe not found."
          exit 1
        }
        
    - name: Install Inno Setup
      run: choco install innosetup -y
        
    - name: Build Installer
      run: |
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer\setup.iss
        
    - name: Upload Installer
      uses: actions/upload-artifact@v4
      with:
        name: Visub_Setup
        path: installer/output/Visub_Setup.exe
        retention-days: 30
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: installer/output/Visub_Setup.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
